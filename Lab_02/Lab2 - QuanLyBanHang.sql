CREATE TABLE KHACHHANG (
	MAKH CHAR(4) NOT NULL PRIMARY KEY,
	HOTEN VARCHAR(40) NOT NULL,
	DCHI VARCHAR(50) NOT NULL,
	SODT VARCHAR(20) NOT NULL,
	NGSINH SMALLDATETIME NOT NULL,
	DOANHSO MONEY NOT NULL,
	NGDK SMALLDATETIME NOT NULL
);

CREATE TABLE NHANVIEN (
	MANV CHAR(4) NOT NULL PRIMARY KEY,
	HOTEN VARCHAR(40) NOT NULL,
	SODT VARCHAR(20) NOT NULL,
	NGVL SMALLDATETIME NOT NULL
);

CREATE TABLE SANPHAM (
	MASP CHAR(4) NOT NULL PRIMARY KEY,
	TENSP VARCHAR(40) NOT NULL,
	DVT VARCHAR(20) NOT NULL,
	NUOCSX VARCHAR(40) NOT NULL,
	GIA MONEY NOT NULL
);

CREATE TABLE HOADON (
	SOHD INT NOT NULL PRIMARY KEY,
	NGHD SMALLDATETIME NOT NULL,
	MAKH CHAR(4),
	FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
	MANV CHAR(4) NOT NULL,
	FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
	TRIGIA MONEY NOT NULL
);

CREATE TABLE CTHD (
	SOHD INT NOT NULL,
	FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD),
	MASP CHAR(4) NOT NULL,
	FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP),
	CONSTRAINT PK_CTHD PRIMARY KEY (SOHD, MASP),
	SL INT NOT NULL
);

ALTER TABLE SANPHAM
	ADD GHICHU varchar(20);

ALTER TABLE KHACHHANG
	ADD LOAIKH tinyint NOT NULL;

ALTER TABLE SANPHAM
	ALTER COLUMN GHICHU varchar(100);

ALTER TABLE SANPHAM
	DROP COLUMN GHICHU;

ALTER TABLE KHACHHANG
	ALTER COLUMN LOAIKH varchar(40);

ALTER TABLE SANPHAM
	ADD CONSTRAINT CK_DVT CHECK (DVT IN ('cay', 'hop', 'cai', 'quyen', 'chuc'));

ALTER TABLE SANPHAM
	ADD CONSTRAINT CK_GIA CHECK (GIA >= 500);

ALTER TABLE CTHD
	ADD CONSTRAINT CK_SL CHECK (SL >= 1);

ALTER TABLE KHACHHANG
	ADD CONSTRAINT CK_NGAYDK CHECK (NGDK > NGSINH);

INSERT INTO NHANVIEN
VALUES
('NV01', 'Nguyen Nhu Nhut', '0927345678', '2006/4/13'),
('NV02', 'Le Thi Phi Yen', '0987567390', '2006/4/21'),
('NV03', 'Nguyen Van B', '09970047382', '2006/4/27'),
('NV04', 'Ngo Thanh Tuan', '0913758498', '2006/6/24'),
('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '2006/7/20');

INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK)
VALUES
('KH01', 'Nguyen Van A', '731 Tran Hung Dao, Q5, TpHCM', '08823451', '1960/10/22', '13,060,000', '2006/7/22'),
('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '1994/4/3', '280,000', '2006/7/30'),
('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '1980/6/12', '3,860,000', '2006/8/5'),
('KH04', 'Tran Minh Long', '50/34 Le Dai Hanh, Q10, TpHCM', '0917325476', '1965/3/9', '250,000', '2006/10/2'),
('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM', '08246108', '1950/3/10', '21,000', '2006/10/28'),
('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631738', '1981/12/31', '915,000', '2006/11/24'),
('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '1971/4/6', '12,500', '2006/12/1'),
('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TpHCM', '0938435756', '1971/1/10', '365,000', '2006/12/13'),
('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TpHCM', '08654763', '1979/9/3', '70,000', '2007/1/14'),
('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TpHCM', '08768904', '1983/5/2', '67,500', '2007/1/16');

INSERT INTO SANPHAM
VALUES
('BC01', 'But chi', 'cay', 'Singapore', '3,000'),
('BC02', 'But chi', 'cay', 'Singapore', '5,000'),
('BC03', 'But chi', 'cay', 'Viet Nam', '3,500'),
('BC04', 'But chi', 'hop', 'Viet Nam', '30,000'),
('BB01', 'But bi', 'cay', 'Viet Nam', '5,000'),
('BB02', 'But bi', 'cay', 'Trung Quoc', '7,000'),
('BB03', 'But bi', 'hop', 'Thai Lan ', '100,000'),
('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', '2,500'),
('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', '4,500'),
('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', '3,000'),
('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', '5,500'),
('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', '23,000'),
('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', '53,000'),
('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', '34,000'),
('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', '40,000'),
('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', '55,000'),
('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', '51,000'),
('ST04', 'So tay', 'quyen', 'Thai Lan', '55,000'),
('ST05', 'So tay mong', 'quyen', 'Thai Lan', '20,000'),
('ST06', 'Phan viet bang', 'hop', 'Viet Nam', '5,000'),
('ST07', 'Phan khong bui', 'hop', 'Viet Nam', '7,000'),
('ST08', 'Bong bang', 'cai', 'Viet Nam', '1,000'),
('ST09', 'But long', 'cay', 'Viet Nam', '5,000'),
('ST10', 'But long', 'cay', 'Trung Quoc', '7,000');

INSERT INTO HOADON
VALUES
(1001, '2006/7/23', 'KH01', 'NV01', '320,000'),
(1002, '2006/8/12', 'KH01', 'NV02', '840,000'),
(1003, '2006/8/23', 'KH02', 'NV01', '100,000'),
(1004, '2006/9/1', 'KH02', 'NV01', '180,000'),
(1005, '2006/10/20', 'KH01', 'NV02', '3,800,000'),
(1006, '2006/10/16', 'KH01', 'NV03', '2,430,000'),
(1007, '2006/10/28', 'KH03', 'NV03', '510,000'),
(1008, '2006/10/28', 'KH01', 'NV03', '440,000'),
(1009, '2006/10/28', 'KH03', 'NV04', '200,000'),
(1010, '2006/11/4', 'KH01', 'NV01', '5,200,000'),
(1011, '2006/11/4', 'KH04', 'NV03', '250,000'),
(1012, '2006/11/30', 'KH05', 'NV03', '21,000'),
(1013, '2006/12/12', 'KH06', 'NV01', '5,000'),
(1014, '2006/12/31', 'KH03', 'NV02', '3,150,000'),
(1015, '2007/1/1', 'KH06', 'NV01', '910,000'),
(1016, '2007/1/1', 'KH07', 'NV02', '12,500'),
(1017, '2007/1/2', 'KH08', 'NV03', '35,000'),
(1018, '2007/1/13', 'KH08', 'NV03', '330,000'),
(1019, '2007/1/13', 'KH01', 'NV03', '30,000'),
(1020, '2007/1/14', 'KH09', 'NV04', '70,000'),
(1021, '2007/1/16', 'KH10', 'NV03', '67,500'),
(1022, '2007/1/16', NULL, 'NV03', '7,000'),
(1023, '2007/1/17', NULL, 'NV01', '330,000');

INSERT INTO CTHD
VALUES
(1001, 'TV02', 10),
(1001, 'ST01', 5),
(1001, 'BC01', 5),
(1001, 'BC02', 10),
(1001, 'ST08', 10),
(1002, 'BC04', 20),
(1002, 'BB01', 20),
(1002, 'BB02', 20),
(1003, 'BB03', 10),
(1004, 'TV01', 20),
(1004, 'TV02', 10),
(1004, 'TV03', 10),
(1004, 'TV04', 10),
(1005, 'TV05', 50),
(1005, 'TV06', 50),
(1006, 'TV07', 20),
(1006, 'ST01', 30),
(1006, 'ST02', 10),
(1007, 'ST03', 10),
(1008, 'ST04', 8),
(1009, 'ST05', 10),
(1010, 'TV07', 50),
(1010, 'ST07', 50),
(1010, 'ST08', 100),
(1010, 'ST04', 50),
(1010, 'TV03', 100),
(1011, 'ST06', 50),
(1012, 'ST07', 3),
(1013, 'ST08', 5),
(1014, 'BC02', 80),
(1014, 'BB02', 100),
(1014, 'BC04', 60),
(1014, 'BB01', 50),
(1015, 'BB02', 30),
(1015, 'BB03', 7),
(1016, 'TV01', 5),
(1017, 'TV02', 1),
(1017, 'TV03', 1),
(1017, 'TV04', 5),
(1018, 'ST04', 6),
(1019, 'ST05', 1),
(1019, 'ST06', 2),
(1020, 'ST07', 10),
(1021, 'ST08', 5),
(1021, 'TV01', 7),
(1021, 'TV02', 10),
(1022, 'ST07', 1),
(1023, 'ST04', 6);

SELECT * INTO SANPHAM1
FROM SANPHAM;

SELECT * INTO KHACHHANG1
FROM KHACHHANG;

UPDATE SANPHAM1
SET GIA = GIA * 1.05
WHERE NUOCSX = 'Thai Lan';

UPDATE SANPHAM1
SET GIA = GIA * 0.95
WHERE NUOCSX = 'Trung Quoc' AND GIA <= 10000;

UPDATE KHACHHANG1
SET LOAIKH = 'Vip'
WHERE (NGDK < '2007-01-01' AND DOANHSO >= 10000000)
   OR (NGDK >= '2007-01-01' AND DOANHSO >= 2000000);

SELECT MASP, TENSP FROM SANPHAM WHERE NUOCSX = 'Trung Quoc';
SELECT MASP, TENSP FROM SANPHAM WHERE DVT IN('cay', 'QUYEN');
SELECT MASP, TENSP FROM SANPHAM WHERE LEFT(MASP, 1) = 'B' AND RIGHT(MASP, 2) = '01';
SELECT MASP, TENSP FROM SANPHAM WHERE NUOCSX = 'Trung Quoc' AND GIA BETWEEN 30000 AND 40000;
SELECT MASP, TENSP FROM SANPHAM WHERE (NUOCSX = 'Trung Quoc' OR NUOCSX = 'Thai Lan') AND GIA BETWEEN 30000 AND 40000;
SELECT SOHD, TRIGIA FROM HOADON WHERE NGHD BETWEEN '2007/1/1' AND '2007/1/2';
SELECT SOHD, TRIGIA FROM HOADON WHERE NGHD BETWEEN '2007/1/1' AND '2007/1/31' ORDER BY NGHD ASC, TRIGIA DESC;

SELECT KHACHHANG.MAKH, KHACHHANG.HOTEN FROM KHACHHANG
JOIN HOADON ON HOADON.MAKH = KHACHHANG.MAKH
WHERE HOADON.NGHD = '2007/1/1';

SELECT HOADON.SOHD, HOADON.TRIGIA FROM HOADON
JOIN NHANVIEN ON NHANVIEN.MANV = HOADON.MANV
WHERE NHANVIEN.HOTEN = 'Nguyen Van B' AND HOADON.NGHD = '2006/10/28';

SELECT CTHD.MASP, SANPHAM.TENSP FROM KHACHHANG
JOIN HOADON ON HOADON.MAKH = KHACHHANG.MAKH
JOIN CTHD ON CTHD.SOHD = HOADON.SOHD
JOIN SANPHAM ON CTHD.MASP = SANPHAM.MASP
WHERE HOTEN = 'Nguyen Van A' AND (NGHD BETWEEN '2006/10/1' AND '2006/10/31');

SELECT DISTINCT SOHD FROM CTHD
WHERE MASP IN ('BB01', 'BB02');
